<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RealEstate PRO - Личный кабинет</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --dark: #1b263b;
            --light: #f8f9fa;
            --gray: #adb5bd;
            --success: #4cc9f0;
            --warning: #f72585;
            --card-bg: #ffffff;
            --sidebar-bg: #2b2d42;
            --header-bg: #3a0ca3;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            display: flex;
            min-height: 100vh;
        }

        /* Сайдбар */
        .sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            color: white;
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            padding: 0 1rem;
        }

        .sidebar-header i {
            font-size: 1.8rem;
            margin-right: 1rem;
            color: var(--primary);
        }

        .sidebar-header h2 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .nav-menu {
            flex-grow: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.8rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            color: rgba(255,255,255,0.8);
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item i {
            margin-right: 1rem;
            font-size: 1.1rem;
        }

        .user-profile {
            padding: 1rem;
            margin-top: auto;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-weight: bold;
            color: white;
        }

        .user-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .user-role {
            font-size: 0.8rem;
            color: var(--gray);
        }

        /* Основное содержимое */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        /* Шапка */
        .header {
            background: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: #f1f3f5;
            border-radius: 30px;
            padding: 0.5rem 1rem;
            width: 300px;
        }

        .search-bar input {
            border: none;
            background: transparent;
            margin-left: 0.5rem;
            width: 100%;
            outline: none;
        }

        .header-actions {
            display: flex;
            align-items: center;
        }

        .notification-bell {
            position: relative;
            margin-right: 1.5rem;
            cursor: pointer;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--warning);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
        }

        .logout-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: var(--secondary);
        }

        .logout-btn i {
            margin-right: 0.5rem;
        }

        /* Контент */
        .content {
            padding: 2rem;
            flex-grow: 1;
            background: #f5f7fa;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 1.8rem;
            color: var(--dark);
            font-weight: 600;
        }

        .add-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }

        .add-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .add-btn i {
            margin-right: 0.5rem;
            font-size: 14px;
        }

        /* Карточки */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
        }

        .card-badge {
            background: var(--primary);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .card-body p {
            color: #666;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .card-date {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin: 0 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-btn i {
            font-size: 14px;
        }

        .action-btn.edit-btn {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }

        .action-btn.edit-btn:hover {
            background: rgba(67, 97, 238, 0.2);
        }

        .action-btn.delete-btn {
            background: rgba(247, 37, 133, 0.1);
            color: var(--warning);
        }

        .action-btn.delete-btn:hover {
            background: rgba(247, 37, 133, 0.2);
        }

        .table-cell {
            display: flex;
            align-items: center;
            padding: 12px;
        }

        .table-cell:last-child {
            justify-content: flex-end;
            gap: 8px;
        }

        /* Таблицы */
        .data-table {
            width: 100%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #eee;
        }

        .table-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
        }

        .table-filters {
            display: flex;
            gap: 1rem;
        }

        .filter-select {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: white;
            outline: none;
        }

        .table-body {
            padding: 0;
        }

        .table-row {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #eee;
            transition: all 0.3s;
        }

        .table-row:hover {
            background: #f9f9f9;
        }

        .table-row.header {
            font-weight: 600;
            background: #f5f7fa;
        }

        .table-cell {
            flex: 1;
            padding: 0 0.5rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-new {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }

        .status-in-progress {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }

        .status-completed {
            background: rgba(72, 149, 239, 0.1);
            color: #4895ef;
        }

        .status-expired {
            background: rgba(247, 37, 133, 0.1);
            color: var(--warning);
        }

        /* Адаптивность */
        @media (max-width: 992px) {
            .sidebar {
                width: 80px;
                padding: 1rem 0.5rem;
            }
            .sidebar-header h2, .nav-item span, .user-info {
                display: none;
            }
            .sidebar-header {
                justify-content: center;
                padding: 0;
            }
            .nav-item {
                justify-content: center;
                padding: 1rem 0;
            }
            .nav-item i {
                margin-right: 0;
                font-size: 1.3rem;
            }
            .user-profile {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .cards-grid {
                grid-template-columns: 1fr;
            }
            .table-filters {
                flex-direction: column;
                gap: 0.5rem;
            }
            .header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            .search-bar {
                width: 100%;
            }
        }

        /* Стили для модального окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background: white;
            margin: 10% auto;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1001;
        }

        /* Обновляем стили для второго модального окна */
        #object-details-modal {
            z-index: 1002;
        }

        #object-details-modal .modal-content {
            z-index: 1003;
        }

        #object-modal {
            z-index: 1004;
        }

        #object-modal .modal-content {
            z-index: 1005;
        }

        .modal-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
            margin-bottom: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }

        .close-btn:hover {
            color: var(--dark);
        }

        /* Стили для деталей объекта */
        .object-details {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .detail-item {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .detail-label {
            font-weight: 500;
            color: var(--dark);
            width: 120px;
            text-align: left;
            margin-right: 10px;
        }

        .detail-item span:not(.detail-label) {
            text-align: left;
            flex-grow: 1;
        }

        .table-cell {
            text-align: left;
        }

        .object-children {
            margin-top: 20px;
        }

        .object-children h4 {
            margin-bottom: 15px;
            color: var(--dark);
        }

        #children-list {
            margin-bottom: 15px;
        }

        .child-object {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .child-object-info {
            flex-grow: 1;
        }

        .child-object-name {
            font-weight: 500;
            color: var(--dark);
        }

        .child-object-type {
            font-size: 0.9rem;
            color: var(--gray);
        }

        /* Стили для формы */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            color: var(--dark);
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
            color: var(--dark);
            transition: border-color 0.3s;
        }

        .form-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
        }

        .form-input:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
            color: var(--dark);
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .form-select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
        }

        .form-actions {
            margin-top: 20px;
            text-align: right;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary);
        }

        /* Стили для фильтров */
        .table-filters {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 14px;
            color: var(--dark);
            cursor: pointer;
            outline: none;
            transition: all 0.3s;
        }

        .filter-select:hover {
            border-color: var(--primary);
        }

        .filter-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
        }

        /* Стили для ссылки названия объекта */
        .object-name-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .object-name-link:hover {
            color: var(--secondary);
            text-decoration: underline;
        }

        /* Стили для хлебных крошек */
        .breadcrumbs {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px 0;
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            font-size: 16px;
            color: var(--gray);
        }

        .breadcrumb-item:not(:last-child)::after {
            content: '>';
            margin-left: 8px;
            color: var(--gray);
        }

        .breadcrumb-item a {
            color: var(--primary);
            text-decoration: none;
            transition: color 0.3s;
        }

        .breadcrumb-item a:hover {
            color: var(--secondary);
        }

        .breadcrumb-item.active {
            color: var(--dark);
            font-weight: 500;
        }

        .modal-title {
            flex-grow: 1;
            margin-right: 20px;
        }

        .children-section {
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .children-section h3 {
            margin-bottom: 15px;
            color: var(--dark);
        }
        
        .children-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        
        .child-card {
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .child-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .child-name {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .child-type {
            color: #666;
            font-size: 14px;
            margin-bottom: 12px;
        }
        
        .child-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        
        .back-button {
            margin-top: 20px;
            text-align: center;
        }
        
        .back-button .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        /* Добавляем стили для нового расположения */
        .object-details-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .object-details-sidebar {
            width: 300px;
            flex-shrink: 0;
        }

        .object-children-main {
            flex-grow: 1;
        }

        .children-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 20px;
        }

        .children-header h3 {
            margin: 0;
            color: var(--dark);
        }

        .no-children {
            grid-column: 1 / -1;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            color: #666;
        }

        /* Добавляем стили для состояний загрузки и ошибок */
        .loading {
            grid-column: 1 / -1;
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        .error-message {
            grid-column: 1 / -1;
            text-align: center;
            padding: 20px;
            color: #dc3545;
            background: #f8d7da;
            border-radius: 8px;
            margin: 10px 0;
        }

        /* Добавляем стили для заметок */
        .notes-content {
            padding: 20px;
        }
        
        .notes-list {
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .note-item {
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 4px solid var(--primary);
        }
        
        .note-date {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .notes-form {
            margin-top: 20px;
        }
        
        .notes-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            resize: vertical;
        }
        
        .no-notes {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        
        .action-btn.notes-btn {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }
        
        .action-btn.notes-btn:hover {
            background: rgba(76, 201, 240, 0.2);
        }

        /* Стили для карточки добавления */
        .add-child-card {
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-child-card:hover {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
        }

        .add-child-card-content {
            text-align: center;
        }

        .add-child-card i {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        /* Стили для иерархии объекта */
        .hierarchy-content {
            padding: 20px;
        }

        .hierarchy-path {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .hierarchy-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 5px;
            position: relative;
        }

        .hierarchy-item:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 20px;
            bottom: -15px;
            width: 2px;
            height: 20px;
            background: var(--primary);
        }

        .hierarchy-name {
            font-weight: 500;
            color: var(--dark);
        }

        .hierarchy-type {
            color: var(--gray);
            margin-left: 10px;
            font-size: 0.9em;
        }

        .view-hierarchy-btn {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .view-hierarchy-btn:hover {
            background: rgba(67, 97, 238, 0.2);
        }

        /* Стили для уведомлений */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 300px;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid var(--primary);
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.error {
            border-left-color: var(--warning);
        }

        .notification i {
            font-size: 20px;
        }

        .notification.success i {
            color: var(--success);
        }

        .notification.error i {
            color: var(--warning);
        }

        .notification-content {
            flex-grow: 1;
        }

        .notification-title {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .notification-message {
            font-size: 14px;
            color: #666;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            padding: 5px;
            font-size: 16px;
        }

        .notification-close:hover {
            color: var(--dark);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Стили для таблицы пользователей */
        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .users-table th,
        .users-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .users-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--dark);
        }

        .users-table tr:hover {
            background-color: #f8f9fa;
        }

        .users-table .action-cell {
            text-align: center;
            width: 100px;
        }

        .users-table .status-cell {
            text-align: center;
            width: 120px;
        }

        .users-table .role-cell {
            text-align: center;
            width: 150px;
        }

        .users-table .id-cell {
            width: 50px;
        }

        .users-table .name-cell {
            width: 150px;
        }

        .users-table .email-cell {
            width: 200px;
        }

        /* Стили для сортировки таблицы */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px;
        }

        .sortable-header:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }

        .sortable-header::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 5px solid var(--gray);
            opacity: 0.5;
        }

        .sortable-header.asc::after {
            border-bottom: 5px solid var(--primary);
            opacity: 1;
        }

        .sortable-header.desc::after {
            border-top: 5px solid var(--primary);
            border-bottom: none;
            opacity: 1;
        }
    </style>
</head>
<body>
<!-- Сайдбар -->
<aside class="sidebar">
    <div class="sidebar-header">
        <i class="fas fa-building"></i>
        <h2>RealEstate PRO</h2>
    </div>

    <nav class="nav-menu">
        <div class="nav-item active" data-section="dashboard">
            <i class="fas fa-tachometer-alt"></i>
            <span>Главная</span>
        </div>
        <div class="nav-item" data-section="objects">
            <i class="fas fa-home"></i>
            <span>Объекты</span>
        </div>
        <div class="nav-item" data-section="tasks">
            <i class="fas fa-tasks"></i>
            <span>Задачи</span>
        </div>
        <div class="nav-item" data-section="profile">
            <i class="fas fa-user"></i>
            <span>Профиль</span>
        </div>
        <div class="nav-item admin-only" data-section="users" style="display: none;">
            <i class="fas fa-users-cog"></i>
            <span>Пользователи</span>
        </div>
    </nav>

    <div class="user-profile">
        <div class="user-avatar" id="user-avatar">JD</div>
        <div class="user-info">
            <div class="user-name" id="user-name">John Doe</div>
            <div class="user-role" id="user-role">Пользователь</div>
        </div>
    </div>
</aside>

<!-- Основное содержимое -->
<main class="main-content">
    <!-- Шапка -->
    <header class="header">
        <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Поиск...">
        </div>

        <div class="header-actions">
            <div class="notification-bell">
                <i class="fas fa-bell"></i>
                <div class="notification-badge">3</div>
            </div>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                Выйти
            </button>
        </div>
    </header>

    <!-- Контент -->
    <div class="content">
        <!-- Дашборд -->
        <section id="dashboard-section" class="content-section">
            <div class="page-header">
                <h1 class="page-title">Главная панель</h1>
            </div>

            <div class="cards-grid">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Объекты недвижимости</h3>
                        <span class="card-badge" id="objects-count">0</span>
                    </div>
                    <div class="card-body">
                        <p>Всего объектов в системе</p>
                    </div>
                    <div class="card-footer">
                        <span class="card-date">Обновлено только что</span>
                        <div class="card-actions">
                            <div class="action-btn edit-btn" onclick="showSection('objects')">
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Активные задачи</h3>
                        <span class="card-badge" id="active-tasks-count">0</span>
                    </div>
                    <div class="card-body">
                        <p>Задачи в работе</p>
                    </div>
                    <div class="card-footer">
                        <span class="card-date">Обновлено только что</span>
                        <div class="card-actions">
                            <div class="action-btn edit-btn" onclick="showSection('tasks')">
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Просроченные</h3>
                        <span class="card-badge" id="expired-tasks-count">0</span>
                    </div>
                    <div class="card-body">
                        <p>Просроченные задачи</p>
                    </div>
                    <div class="card-footer">
                        <span class="card-date">Обновлено только что</span>
                        <div class="card-actions">
                            <div class="action-btn edit-btn" onclick="showSection('tasks')">
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="data-table">
                <div class="table-header">
                    <h3 class="table-title">Последние задачи</h3>
                </div>
                <div class="table-body">
                    <div class="table-row header">
                        <div class="table-cell">Название</div>
                        <div class="table-cell">Объект</div>
                        <div class="table-cell">Статус</div>
                        <div class="table-cell">Дедлайн</div>
                        <div class="table-cell">Действия</div>
                    </div>
                    <div id="recent-tasks-list">
                        <!-- Задачи будут загружены через JS -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Секция объектов -->
        <section id="objects-section" class="content-section" style="display: none;">
            <div class="page-header">
                <h1 class="page-title">Объекты недвижимости</h1>
                <button class="add-btn" onclick="showAddObjectModal()">
                    <i class="fas fa-plus"></i>
                    Добавить объект
                </button>
            </div>
            <div id="objects-content">
                <!-- Содержимое будет загружено через JS -->
            </div>
        </section>

        <!-- Секция задач -->
        <section id="tasks-section" class="content-section" style="display: none;">
            <div class="page-header">
                <h1 class="page-title">Задачи</h1>
                <button class="add-btn" onclick="showAddTaskModal()">
                    <i class="fas fa-plus"></i>
                    Добавить задачу
                </button>
            </div>
            <div id="tasks-content">
                <!-- Содержимое будет загружено через JS -->
            </div>
        </section>

        <!-- Секция профиля -->
        <section id="profile-section" class="content-section" style="display: none;">
            <div class="page-header">
                <h1 class="page-title">Профиль пользователя</h1>
            </div>
            <div id="profile-content">
                <!-- Содержимое будет загружено через JS -->
            </div>
        </section>

        <!-- Секция пользователей (только для админа) -->
        <section id="users-section" class="content-section" style="display: none;">
            <div class="page-header">
                <h1 class="page-title">Управление пользователями</h1>
                <button class="add-btn" onclick="showAddUserModal()">
                    <i class="fas fa-plus"></i>
                    Добавить пользователя
                </button>
            </div>
            <div id="users-content">
                <!-- Содержимое будет загружено через JS -->
            </div>
        </section>
    </div>

    <!-- Модальное окно для создания объекта -->
    <div id="object-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Создание объекта</h3>
                <button class="close-btn" onclick="closeObjectModal()">&times;</button>
            </div>
            <form id="object-form">
                <input type="hidden" id="object-id">
                <div class="form-group">
                    <label class="form-label" for="parent-select">Родительский объект</label>
                    <select class="form-select" id="parent-select">
                        <option value="">Без родительского объекта</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="object-name">Название объекта</label>
                    <input type="text" class="form-input" id="object-name" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="object-type">Тип объекта</label>
                    <select class="form-select" id="object-type" required>
                        <option value="BUILDING">Здание</option>
                        <option value="ENTRANCE">Подъезд</option>
                        <option value="BASEMENT_FLOOR">Цокольный этаж</option>
                        <option value="FLOOR">Этаж</option>
                        <option value="STAIRWELL">Лестничный пролет</option>
                        <option value="ELEVATOR">Лифт</option>
                        <option value="FLOOR_BALCONY">Балкон этажа</option>
                        <option value="CORRIDOR">Коридор</option>
                        <option value="ELEVATOR_HALL">Холл лифта</option>
                        <option value="APARTMENT">Квартира</option>
                        <option value="APARTMENT_BALCONY">Балкон квартиры</option>
                        <option value="ROOM">Комната</option>
                        <option value="TASK">Задача</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Создать</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно для просмотра деталей объекта -->
    <div id="object-details-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    ${breadcrumbs}
                </div>
                <button class="close-btn" onclick="showObjectsList()">&times;</button>
            </div>
            <div class="object-details-container">
                <div class="object-details-sidebar">
                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">Детали объекта</h3>
                        </div>
                        <div class="table-body">
                            <div class="table-row">
                                <div class="table-cell">
                                    <div class="detail-item">
                                        <span class="detail-label">Название:</span>
                                        <span id="detail-name"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="table-row">
                                <div class="table-cell">
                                    <div class="detail-item">
                                        <span class="detail-label">Тип:</span>
                                        <span id="detail-type"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="table-row">
                                <div class="table-cell">
                                    <div class="detail-item">
                                        <span class="detail-label">Дата создания:</span>
                                        <span id="detail-created-at"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="back-button">
                        <button class="btn btn-primary" onclick="loadObjects()">
                            <i class="fas fa-arrow-left"></i>
                            Вернуться к списку
                        </button>
                    </div>
                </div>
                <div class="object-children-main">
                    <div class="children-header">
                        <h3>Дочерние объекты</h3>
                        <button class="add-btn" onclick="showAddChildObjectModal()">
                            <i class="fas fa-plus"></i>
                            Добавить дочерний объект
                        </button>
                    </div>
                    <div id="children-list" class="children-grid">
                        <!-- Дочерние объекты будут загружены через loadChildren -->
                    </div>
                </div>
            </div>
            <div class="back-button">
                ${object.parentId ? `
                    <button class="btn btn-primary" onclick="showObjectDetails(${object.parentId})" style="margin-right: 10px;">
                        <i class="fas fa-arrow-up"></i>
                        Назад
                    </button>
                ` : ''}
                <button class="btn btn-primary" onclick="loadObjects()">
                    <i class="fas fa-arrow-left"></i>
                    Вернуться к списку
                </button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для иерархии объекта -->
    <div id="hierarchy-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Иерархия объекта</h3>
                <button class="close-btn" onclick="closeHierarchyModal()">&times;</button>
            </div>
            <div class="hierarchy-content">
                <div id="hierarchy-path" class="hierarchy-path">
                    <!-- Путь объекта будет загружен здесь -->
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для редактирования пользователя -->
    <div id="edit-user-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Редактирование пользователя</h3>
                <button class="close-btn" onclick="closeEditUserModal()">&times;</button>
            </div>
            <form id="edit-user-form">
                <div class="form-group">
                    <label class="form-label" for="edit-username">Имя пользователя</label>
                    <input type="text" class="form-input" id="edit-username" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-email">Email</label>
                    <input type="email" class="form-input" id="edit-email">
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-firstname">Имя</label>
                    <input type="text" class="form-input" id="edit-firstname">
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-lastname">Фамилия</label>
                    <input type="text" class="form-input" id="edit-lastname">
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-roles">Роль</label>
                    <select class="form-select" id="edit-roles">
                        <option value="ROLE_USER">Пользователь</option>
                        <option value="ROLE_ADMIN">Администратор</option>
                        <option value="ROLE_DIRECTOR">Директор</option>
                        <option value="ROLE_CHIEF">Начальник</option>
                        <option value="ROLE_RESPONSIBLE">Ответственный</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-active">Статус</label>
                    <select class="form-select" id="edit-active">
                        <option value="true">Активен</option>
                        <option value="false">Заблокирован</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</main>

<!-- Добавляем контейнер для уведомлений перед закрывающим тегом body -->
<div class="notification-container" id="notification-container"></div>

<script>
    // Токен и данные пользователя
    let jwtToken = localStorage.getItem('jwt');
    let currentUser = null;
    let isAdmin = false;
    let currentParentId = null; // Добавляем глобальную переменную для хранения ID текущего родительского объекта

    // Проверка авторизации при загрузке
    document.addEventListener('DOMContentLoaded', function() {
        // Если токена нет - редирект на страницу входа
        if (!jwtToken) {
            window.location.href = 'login.html';
            return;
        }

        // Загружаем данные пользователя
        loadUserData();

        // Настройка навигации
        setupNavigation();

        // Загружаем начальные данные для дашборда
        loadDashboardData();

        // Запускаем автоматическое обновление
        startDashboardAutoRefresh();
    });

    // Загрузка данных пользователя
    function loadUserData() {
        fetch("http://localhost:8080/users/info", {
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка авторизации');
                }
                return response.json();
            })
            .then(data => {
                currentUser = data;
                updateUIWithUserData(data);
            })
            .catch(error => {
                console.error('Ошибка:', error);
                logout();
            });
    }

    // Обновление UI с данными пользователя
    function updateUIWithUserData(userData) {
        document.getElementById('user-name').textContent = userData.username || 'Пользователь';
        document.getElementById('user-avatar').textContent = getInitials(userData.username || 'П');

        // Проверяем, является ли пользователь администратором
        isAdmin = userData.roles === 'ROLE_ADMIN';
        document.getElementById('user-role').textContent = isAdmin ? 'Администратор' : 'Пользователь';

        // Показываем/скрываем административные разделы
        document.querySelectorAll('.admin-only').forEach(el => {
            el.style.display = isAdmin ? 'flex' : 'none';
        });
    }

    // Получение инициалов
    function getInitials(username) {
        if (!username) return 'U';
        const parts = username.split(' ');
        if (parts.length > 1) {
            return (parts[0].charAt(0) + parts[1].charAt(0)).toUpperCase();
        }
        return username.substring(0, 2).toUpperCase();
    }

    // Настройка навигации
    function setupNavigation() {
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            item.addEventListener('click', function() {
                // Удаляем активный класс у всех элементов
                navItems.forEach(i => i.classList.remove('active'));
                // Добавляем активный класс текущему элементу
                this.classList.add('active');

                // Получаем секцию для отображения
                const section = this.getAttribute('data-section');
                showSection(section);
            });
        });
    }

    // Показать секцию
    function showSection(sectionId) {
        // Скрываем все секции
        document.querySelectorAll('.content-section').forEach(section => {
            section.style.display = 'none';
        });
        
        // Показываем выбранную секцию
        const selectedSection = document.getElementById(sectionId + '-section');
        if (selectedSection) {
            selectedSection.style.display = 'block';
            
            // Загружаем данные для выбранной секции
            switch(sectionId) {
                case 'objects':
                    loadObjects();
                    break;
                case 'tasks':
                    loadTasks();
                    break;
                case 'profile':
                    loadProfile();
                    break;
                case 'users':
                    loadUsers();
                    break;
            }
        }
        
        // Обновляем активный пункт меню в сайдбаре
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Находим соответствующий пункт меню в сайдбаре и делаем его активным
        const navItem = document.querySelector(`.nav-item[data-section="${sectionId}"]`);
        if (navItem) {
            navItem.classList.add('active');
        }
    }

    // Загрузка данных для дашборда
    function loadDashboardData() {
        // Загружаем объекты недвижимости
        fetch("http://localhost:8080/real-estate-objects", {
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Ошибка загрузки объектов');
            return response.json();
        })
        .then(objects => {
            // Показываем общее количество всех объектов, включая дочерние
            let totalObjects = objects.length;
            console.log('Total objects found:', totalObjects);
            document.getElementById('objects-count').textContent = totalObjects;
        })
        .catch(error => {
            console.error('Ошибка загрузки объектов:', error);
            document.getElementById('objects-count').textContent = '0';
        });

        // Загружаем задачи
        fetch("http://localhost:8080/tasks", {
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Ошибка загрузки задач');
            return response.json();
        })
        .then(tasks => {
            const activeTasks = tasks.filter(task =>
                task.status === 'NEW' || task.status === 'IN_PROGRESS' || task.status === 'URGENT');
            const expiredTasks = tasks.filter(task => task.status === 'EXPIRED');

            document.getElementById('active-tasks-count').textContent = activeTasks.length || 0;
            document.getElementById('expired-tasks-count').textContent = expiredTasks.length || 0;

            // Отображаем последние задачи
            renderRecentTasks(tasks.slice(0, 5));
        })
        .catch(error => {
            console.error('Ошибка загрузки задач:', error);
            document.getElementById('active-tasks-count').textContent = '0';
            document.getElementById('expired-tasks-count').textContent = '0';
            renderRecentTasks([]);
        });
    }

    // Функция для автоматического обновления данных дашборда
    function startDashboardAutoRefresh() {
        // Обновляем данные каждую минуту
        setInterval(loadDashboardData, 60000);
    }

    // Отображение последних задач
    function renderRecentTasks(tasks) {
        const container = document.getElementById('recent-tasks-list');
        container.innerHTML = '';

        if (!tasks || tasks.length === 0) {
            container.innerHTML = '<div class="table-row"><div class="table-cell" colspan="5">Задачи не найдены</div></div>';
            return;
        }

        tasks.forEach(task => {
            const row = document.createElement('div');
            row.className = 'table-row';

            // Форматируем дату дедлайна
            let deadline = 'Не указан';
            if (task.deadline) {
                const deadlineDate = new Date(task.deadline);
                deadline = deadlineDate.toLocaleDateString() + ' ' + deadlineDate.toLocaleTimeString();
            }

            // Определяем класс статуса
            let statusClass = '';
            let statusText = '';
            if (task.status === 'NEW') {
                statusClass = 'status-new';
                statusText = 'Новая';
            } else if (task.status === 'IN_PROGRESS') {
                statusClass = 'status-in-progress';
                statusText = 'В работе';
            } else if (task.status === 'COMPLETED') {
                statusClass = 'status-completed';
                statusText = 'Завершена';
            } else if (task.status === 'EXPIRED') {
                statusClass = 'status-expired';
                statusText = 'Просрочена';
            } else if (task.status === 'URGENT') {
                statusClass = 'status-expired';
                statusText = 'Срочная';
            }

            row.innerHTML = `
                <div class="table-cell">${task.title || 'Без названия'}</div>
                <div class="table-cell">${task.realEstateObject ? task.realEstateObject.name : 'Не указан'}</div>
                <div class="table-cell"><span class="status-badge ${statusClass}">${statusText}</span></div>
                <div class="table-cell">${deadline}</div>
                <div class="table-cell">
                    <div class="action-btn edit-btn" onclick="editTask('${task.id}')">
                        <i class="fas fa-edit"></i>
                    </div>
                </div>
            `;
            container.appendChild(row);
        });
    }

    // Выход из системы
    function logout() {
        // Отправляем запрос на сервер для выхода
        fetch("http://localhost:8080/auth/logout", {
            method: "POST",
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json'
            }
        })
            .finally(() => {
                // Очищаем локальное хранилище и перенаправляем на страницу входа
                localStorage.removeItem('jwt');
                window.location.href = 'login.html';
            });
    }

    // Загрузка объектов (заглушка)
    function loadObjects() {
        const pageTitle = document.querySelector('#objects-section .page-title');
        pageTitle.textContent = 'Объекты недвижимости';
        
        fetch("http://localhost:8080/real-estate-objects", {
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(objects => {
            const container = document.getElementById('objects-content');
            container.innerHTML = `
                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Список объектов</h3>
                        <div class="table-filters">
                            <select class="filter-select" id="object-type-filter" onchange="filterObjects()">
                                <option value="">Все типы</option>
                                <option value="BUILDING">Здание</option>
                                <option value="ENTRANCE">Подъезд</option>
                                <option value="BASEMENT_FLOOR">Цокольный этаж</option>
                                <option value="FLOOR">Этаж</option>
                                <option value="STAIRWELL">Лестничный пролет</option>
                                <option value="ELEVATOR">Лифт</option>
                                <option value="FLOOR_BALCONY">Балкон этажа</option>
                                <option value="CORRIDOR">Коридор</option>
                                <option value="ELEVATOR_HALL">Холл лифта</option>
                                <option value="APARTMENT">Квартира</option>
                                <option value="APARTMENT_BALCONY">Балкон квартиры</option>
                                <option value="ROOM">Комната</option>
                                <option value="TASK">Задача</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-body">
                        <div class="table-row header">
                            <div class="table-cell">Название</div>
                            <div class="table-cell">Тип</div>
                            <div class="table-cell">Родительский объект</div>
                            <div class="table-cell">Создатель</div>
                            <div class="table-cell">Дата создания</div>
                            <div class="table-cell">Действия</div>
                        </div>
                        <div id="objects-list">
                            ${objects.length > 0 ? objects.map(object => `
                                <div class="table-row" data-type="${object.objectType}">
                                    <div class="table-cell">
                                        <a href="#" onclick="showObjectDetails(${object.id})" class="object-name-link">
                                            ${object.name}
                                        </a>
                                    </div>
                                    <div class="table-cell">${getObjectTypeName(object.objectType)}</div>
                                    <div class="table-cell">
                                        ${object.parentId ? 
                                            `<button class="view-hierarchy-btn" onclick="event.stopPropagation(); showHierarchyModal(${object.id})">
                                                <i class="fas fa-sitemap"></i> Просмотреть иерархию
                                            </button>` : 
                                            '-'
                                        }
                                    </div>
                                    <div class="table-cell">
                                        ${object.createdByFirstName && object.createdByLastName ? 
                                            `${object.createdByFirstName} ${object.createdByLastName}` : 
                                            '-'
                                        }
                                    </div>
                                    <div class="table-cell">${new Date(object.createdAt).toLocaleString()}</div>
                                    <div class="table-cell">
                                        <div class="action-btn edit-btn" onclick="editObject(${object.id})" title="Редактировать">
                                            <i class="fas fa-edit"></i>
                                        </div>
                                        <div class="action-btn delete-btn" onclick="deleteObject(${object.id})" title="Удалить">
                                            <i class="fas fa-trash"></i>
                                        </div>
                                    </div>
                                </div>
                            `).join('') : '<div class="table-row"><div class="table-cell" colspan="6">Нет объектов</div></div>'}
                        </div>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            console.error('Ошибка загрузки объектов:', error);
            const container = document.getElementById('objects-content');
            container.innerHTML = '<div class="error">Ошибка загрузки объектов</div>';
        });
    }

    function getObjectTypeName(type) {
        const types = {
            'BUILDING': 'Здание',
            'ENTRANCE': 'Подъезд',
            'BASEMENT_FLOOR': 'Цокольный этаж',
            'FLOOR': 'Этаж',
            'STAIRWELL': 'Лестничный пролет',
            'ELEVATOR': 'Лифт',
            'FLOOR_BALCONY': 'Балкон этажа',
            'CORRIDOR': 'Коридор',
            'ELEVATOR_HALL': 'Холл лифта',
            'APARTMENT': 'Квартира',
            'APARTMENT_BALCONY': 'Балкон квартиры',
            'ROOM': 'Комната',
            'TASK': 'Задача'
        };
        return types[type] || type;
    }

    // Функция фильтрации объектов
    function filterObjects() {
        const selectedType = document.getElementById('object-type-filter').value;
        const rows = document.querySelectorAll('#objects-list .table-row');
        
        rows.forEach(row => {
            if (!selectedType || row.getAttribute('data-type') === selectedType) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Обновляем функцию showObjectDetails
    function showObjectDetails(objectId) {
        console.log('Opening object details for ID:', objectId);
        
        fetch(`http://localhost:8080/real-estate-objects/${objectId}`, {
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('Object details response status:', response.status);
            if (!response.ok) {
                throw new Error('Ошибка загрузки деталей объекта');
            }
            return response.json();
        })
        .then(object => {
            console.log('Received object details:', object);
            
            // Обновляем заголовок секции
            const pageTitle = document.querySelector('#objects-section .page-title');
            pageTitle.textContent = object.name;

            // Устанавливаем текущий родительский ID
            currentParentId = object.parentId;
            console.log('Set currentParentId to:', currentParentId);

            // Формируем хлебные крошки
            let breadcrumbsHtml = '';
            if (object.parentId) {
                fetch(`http://localhost:8080/real-estate-objects/${object.parentId}`, {
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(parentObject => {
                    breadcrumbsHtml = `
                        <div class="breadcrumbs">
                            <a href="#" onclick="showObjectDetails(${parentObject.id})" class="object-name-link">
                                ${parentObject.name}
                            </a>
                            <span class="breadcrumb-separator"> / </span>
                            <span class="current-object">${object.name}</span>
                        </div>
                    `;
                    updateContent();
                });
            } else {
                updateContent();
            }

            function updateContent() {
                // Обновляем содержимое секции
                const container = document.getElementById('objects-content');
                container.innerHTML = `
                    <div class="children-section">
                        <div class="children-header">
                            ${breadcrumbsHtml}
                        </div>
                        <div id="children-list" class="children-grid">
                            <!-- Дочерние объекты будут загружены через loadChildren -->
                        </div>
                    </div>
                    <div class="object-details">
                        <div class="data-table">
                            <div class="table-header">
                                <h3 class="table-title">Детали объекта</h3>
                            </div>
                            <div class="table-body">
                                <div class="table-row">
                                    <div class="table-cell">
                                        <div class="detail-item">
                                            <span class="detail-label">Название:</span>
                                            <span>${object.name}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-row">
                                    <div class="table-cell">
                                        <div class="detail-item">
                                            <span class="detail-label">Тип:</span>
                                            <span>${getObjectTypeName(object.objectType)}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-row">
                                    <div class="table-cell">
                                        <div class="detail-item">
                                            <span class="detail-label">Дата создания:</span>
                                            <span>${new Date(object.createdAt).toLocaleString()}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-row">
                                    <div class="table-cell">
                                        <div class="detail-item">
                                            <span class="detail-label">Создатель:</span>
                                            <span>${object.createdByFirstName && object.createdByLastName ? 
                                                `${object.createdByFirstName} ${object.createdByLastName}` : 
                                                '-'
                                            }</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="back-button">
                        <button class="btn btn-primary" onclick="loadObjects()">
                            <i class="fas fa-arrow-left"></i>
                            Вернуться к списку
                        </button>
                    </div>
                `;
                
                // Сохраняем ID текущего объекта
                currentParentId = objectId;
                console.log('Set currentParentId to:', currentParentId);
                
                // Загружаем дочерние объекты
                loadChildren(objectId);
            }
        })
        .catch(error => {
            console.error('Ошибка загрузки деталей объекта:', error);
            alert('Ошибка загрузки деталей объекта');
        });
    }

    // Обновляем функцию loadChildren
    function loadChildren(parentId) {
        const jwtToken = localStorage.getItem('jwt');
        const container = document.getElementById('children-list');
        container.innerHTML = '<div class="loading">Загрузка дочерних объектов...</div>';

        fetch(`http://localhost:8080/real-estate-objects/${parentId}/children`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка загрузки дочерних объектов');
            }
            return response.json();
        })
        .then(children => {
            let childrenHTML = '';
            
            if (children && children.length > 0) {
                children.forEach(child => {
                    childrenHTML += `
                        <div class="child-card">
                            <div class="child-name">
                                <a href="#" onclick="showObjectDetails(${child.id}); return false;" class="object-name-link">
                                    ${child.name}
                                </a>
                            </div>
                            <div class="child-type">${getObjectTypeName(child.objectType)}</div>
                            <div class="child-actions">
                                <div class="action-btn edit-btn" onclick="editObject(${child.id})" title="Редактировать">
                                    <i class="fas fa-edit"></i>
                                </div>
                                <div class="action-btn delete-btn" onclick="deleteObject(${child.id})" title="Удалить">
                                    <i class="fas fa-trash"></i>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            // Добавляем карточку для создания нового дочернего объекта
            const addChildCardHTML = `
                <div class="add-child-card" onclick="showAddChildObjectModal(${parentId})">
                    <div class="add-child-card-content">
                        <i class="fas fa-plus"></i>
                    </div>
                </div>
            `;

            container.innerHTML = childrenHTML + addChildCardHTML;
        })
        .catch(error => {
            console.error('Ошибка загрузки дочерних объектов:', error);
            container.innerHTML = '<div class="error">Ошибка загрузки дочерних объектов</div>';
        });
    }

    // Добавляем новую функцию для показа модального окна создания дочернего объекта
    function showAddChildObjectModal(parentId) {
        const modal = document.getElementById('object-modal');
        document.getElementById('modal-title').textContent = 'Создание дочернего объекта';
        document.querySelector('#object-form button[type="submit"]').textContent = 'Создать'; // Устанавливаем текст кнопки

        // Очищаем форму и сбрасываем обработчик
        const form = document.getElementById('object-form');
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);
        const currentForm = document.getElementById('object-form');
        currentForm.reset(); 
        currentForm.onsubmit = null; // Очищаем обработчик
        document.getElementById('object-id').value = '';
        document.getElementById('parent-select').disabled = true; // Блокируем выбор родителя

        // Загружаем родителя
        const parentSelect = document.getElementById('parent-select');
        fetch(`http://localhost:8080/real-estate-objects/${parentId}`, {
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(parentObject => {
            parentSelect.innerHTML = `<option value="${parentId}" selected>${parentObject.name} (${getObjectTypeName(parentObject.objectType)})</option>`;
        })
        .catch(error => {
            console.error('Error loading parent object:', error);
            parentSelect.innerHTML = '<option value="">Ошибка загрузки родителя</option>';
        });

        // Назначаем обработчик для СОЗДАНИЯ ДОЧЕРНЕГО
        currentForm.onsubmit = function(e) {
            e.preventDefault();
            const objectName = document.getElementById('object-name').value;
            const objectType = document.getElementById('object-type').value;
            const data = { name: objectName, objectType: objectType, parentId: parentId };

            fetch('http://localhost:8080/real-estate-objects', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${jwtToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) { return response.text().then(text => { throw new Error(text || 'Ошибка при создании объекта'); }); }
                return response.json();
            })
            .then(data => {
                closeObjectModal();
                loadChildren(parentId); // Обновляем список дочерних объектов
            })
            .catch(error => {
                console.error('Ошибка при создании объекта:', error);
                alert('Ошибка при создании объекта: ' + error.message);
            });
        };

        modal.style.display = 'block';
    }

    // Обновляем обработчик формы
    document.getElementById('object-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const objectName = document.getElementById('object-name').value;
        const objectType = document.getElementById('object-type').value;
        const parentId = document.getElementById('parent-select').value;
        
        // Формируем данные объекта
        const data = {
            name: objectName,
            objectType: objectType
        };
        
        // Добавляем parentId только если он выбран
        if (parentId) {
            data.parentId = parseInt(parentId);
        }
        
        console.log('Sending data to server:', data);

        fetch('http://localhost:8080/real-estate-objects', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(text || 'Ошибка при создании объекта');
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Object created successfully:', data);
            // Закрываем модальное окно
            document.getElementById('object-modal').style.display = 'none';
            
            // Обновляем список объектов
            if (parentId) {
                // Если создавали дочерний объект, обновляем детали родителя
                showObjectDetails(parentId);
            } else {
                // Если создавали обычный объект, обновляем список
                loadObjects();
            }
        })
        .catch(error => {
            console.error('Ошибка при создании объекта:', error);
            alert('Ошибка при создании объекта: ' + error.message);
        });
    });

    // Функция для закрытия модального окна
    function closeObjectModal() {
        const modal = document.getElementById('object-modal');
        modal.style.display = 'none';
        const form = document.getElementById('object-form');
        // Клонируем форму, чтобы удалить все слушатели событий
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);
        // Сбрасываем значения новой формы
        newForm.reset(); 
        newForm.onsubmit = null; // Явно удаляем обработчик
        document.getElementById('object-id').value = '';
        document.getElementById('parent-select').disabled = false;
        document.getElementById('parent-select').innerHTML = '<option value="">Загрузка...</option>';
        document.querySelector('#object-form button[type="submit"]').textContent = 'Создать'; // Возвращаем текст кнопки по умолчанию
    }

    // Функция для возврата к списку объектов
    function showObjectsList() {
        loadObjects();
    }

    // Добавляем функцию для отображения заметок объекта
    function showObjectNotes(objectId) {
        console.log('Opening notes for object ID:', objectId);
        
        // Получаем информацию об объекте
        fetch(`http://localhost:8080/real-estate-objects/${objectId}`, {
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(object => {
            // Создаем модальное окно для заметок
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'notes-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Заметки объекта: ${object.name}</h3>
                        <button class="close-btn" onclick="closeNotesModal()">&times;</button>
                    </div>
                    <div class="notes-content">
                        <div class="notes-list" id="notes-list">
                            <!-- Заметки будут загружены здесь -->
                        </div>
                        <div class="notes-form">
                            <textarea id="new-note" placeholder="Введите новую заметку..." rows="3"></textarea>
                            <button class="btn btn-primary" onclick="addNote(${objectId})">Добавить заметку</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            // Загружаем существующие заметки
            loadNotes(objectId);
        })
        .catch(error => {
            console.error('Error loading object details:', error);
            alert('Ошибка загрузки информации об объекте');
        });
    }

    // Функция для загрузки заметок
    function loadNotes(objectId) {
        const notesList = document.getElementById('notes-list');
        if (!notesList) return;
        
        // Здесь будет запрос к API для получения заметок
        // Пока что просто показываем заглушку
        notesList.innerHTML = '<div class="no-notes">Нет заметок</div>';
    }

    // Функция для добавления заметки
    function addNote(objectId) {
        const noteText = document.getElementById('new-note').value;
        if (!noteText.trim()) {
            alert('Введите текст заметки');
            return;
        }
        
        // Здесь будет запрос к API для добавления заметки
        console.log('Adding note:', noteText, 'for object:', objectId);
        
        // Очищаем поле ввода
        document.getElementById('new-note').value = '';
    }

    // Функция для закрытия модального окна заметок
    function closeNotesModal() {
        const modal = document.getElementById('notes-modal');
        if (modal) {
            modal.remove();
        }
    }

    // Функция для удаления объекта
    function deleteObject(objectId) {
        if (!confirm('Вы уверены, что хотите удалить этот объект?')) {
            return;
        }

        fetch(`http://localhost:8080/real-estate-objects/${objectId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(text || 'Ошибка при удалении объекта');
                });
            }
            
            // Проверяем, находимся ли мы в деталях объекта
            const objectsContent = document.getElementById('objects-content');
            const isInDetailsView = objectsContent.querySelector('.children-section') !== null;
            
            if (isInDetailsView) {
                console.log('Updating children list for parent:', currentParentId);
                loadChildren(currentParentId);
            } else {
                console.log('Updating main objects list');
                loadObjects();
            }
            
            // Обновляем данные на дашборде
            loadDashboardData();
        })
        .catch(error => {
            console.error('Ошибка при удалении объекта:', error);
            alert('Ошибка при удалении объекта: ' + error.message);
        });
    }

    // Функции для работы с иерархией объектов
    function showHierarchyModal(objectId) {
        const modal = document.getElementById('hierarchy-modal');
        const hierarchyPath = document.getElementById('hierarchy-path');
        hierarchyPath.innerHTML = '<div class="loading">Загрузка иерархии...</div>';
        modal.style.display = 'block';

        // Рекурсивная функция для получения цепочки родителей
        async function getParentChain(id, chain = []) {
            try {
                const response = await fetch(`http://localhost:8080/real-estate-objects/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                const object = await response.json();
                chain.unshift(object); // Добавляем объект в начало массива

                if (object.parentId) {
                    return getParentChain(object.parentId, chain);
                }
                return chain;
            } catch (error) {
                console.error('Error loading object:', error);
                return chain;
            }
        }

        // Загружаем и отображаем цепочку родителей
        getParentChain(objectId).then(chain => {
            hierarchyPath.innerHTML = chain.map((obj, index) => `
                <div class="hierarchy-item">
                    <div class="hierarchy-name">${obj.name}</div>
                    <div class="hierarchy-type">${getObjectTypeName(obj.objectType)}</div>
                </div>
            `).join('');
        }).catch(error => {
            hierarchyPath.innerHTML = '<div class="error">Ошибка загрузки иерархии</div>';
        });
    }

    function closeHierarchyModal() {
        document.getElementById('hierarchy-modal').style.display = 'none';
    }

    function editObject(objectId) {
        console.log('Editing object:', objectId);
        
        // Устанавливаем заголовок модального окна
        document.getElementById('modal-title').textContent = 'Редактирование объекта';
        
        // Меняем текст кнопки
        document.querySelector('#object-form button[type="submit"]').textContent = 'Сохранить';
        
        // Клонируем форму, чтобы удалить старые обработчики
        const form = document.getElementById('object-form');
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);
        
        // Получаем данные объекта
        fetch(`http://localhost:8080/real-estate-objects/${objectId}`, {
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка загрузки данных объекта');
            }
            return response.json();
        })
        .then(object => {
            console.log('Loaded object data:', object);
            
            // Заполняем форму данными объекта
            const form = document.getElementById('object-form');
            form.querySelector('#object-name').value = object.name;
            form.querySelector('#object-type').value = object.objectType;
            
            // Если есть родительский объект, загружаем его данные
            if (object.parentId) {
                fetch(`http://localhost:8080/real-estate-objects/${object.parentId}`, {
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка загрузки данных родительского объекта');
                    }
                    return response.json();
                })
                .then(parentObject => {
                    const parentSelect = form.querySelector('#parent-select');
                    parentSelect.innerHTML = `<option value="${parentObject.id}">${parentObject.name} (${getObjectTypeName(parentObject.objectType)})</option>`;
                    parentSelect.value = parentObject.id;
                    parentSelect.disabled = true; // Блокируем изменение родителя при редактировании
                })
                .catch(error => {
                    console.error('Error loading parent object:', error);
                    const parentSelect = form.querySelector('#parent-select');
                    parentSelect.innerHTML = '<option value="">Ошибка загрузки родительского объекта</option>';
                });
            } else {
                // Если родителя нет, очищаем селект
                const parentSelect = form.querySelector('#parent-select');
                parentSelect.innerHTML = '<option value="">Без родительского объекта</option>';
                parentSelect.value = '';
            }
            
            // Устанавливаем обработчик отправки формы
            form.onsubmit = function(e) {
                e.preventDefault();
                
                const formData = {
                    name: form.querySelector('#object-name').value,
                    objectType: form.querySelector('#object-type').value,
                    parentId: object.parentId // Сохраняем текущего родителя
                };
                
                console.log('Sending update request with data:', formData);
                
                fetch(`http://localhost:8080/real-estate-objects/${objectId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка обновления объекта');
                    }
                    return response.json();
                })
                .then(updatedObject => {
                    console.log('Object updated successfully:', updatedObject);
                    closeObjectModal();
                    
                    // Проверяем, находимся ли мы в деталях объекта
                    const objectsContent = document.getElementById('objects-content');
                    const isInDetailsView = objectsContent.querySelector('.children-section') !== null;
                    
                    if (isInDetailsView) {
                        console.log('Updating children list for parent:', currentParentId);
                        loadChildren(currentParentId);
                    } else {
                        console.log('Updating main objects list');
                        loadObjects();
                    }
                    
                    // Обновляем данные на дашборде
                    loadDashboardData();
                })
                .catch(error => {
                    console.error('Error updating object:', error);
                    alert('Ошибка при обновлении объекта: ' + error.message);
                });
            };
        })
        .catch(error => {
            console.error('Error loading object:', error);
            alert('Ошибка при загрузке данных объекта: ' + error.message);
        });
        
        // Показываем модальное окно
        document.getElementById('object-modal').style.display = 'block';
    }

    // Функция для показа модального окна создания объекта (главного)
    function showAddObjectModal() {
        const modal = document.getElementById('object-modal');
        document.getElementById('modal-title').textContent = 'Создание объекта';
        document.querySelector('#object-form button[type="submit"]').textContent = 'Создать'; // Устанавливаем текст кнопки

        // Очищаем форму и сбрасываем обработчик
        const form = document.getElementById('object-form');
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);
        const currentForm = document.getElementById('object-form');
        currentForm.reset(); 
        currentForm.onsubmit = null; // Очищаем обработчик
        document.getElementById('object-id').value = '';
        document.getElementById('parent-select').disabled = false; // Разблокируем выбор родителя

        // Загружаем список родительских объектов
        const parentSelect = document.getElementById('parent-select');
        parentSelect.innerHTML = '<option value="">Загрузка...</option>';

        fetch('http://localhost:8080/real-estate-objects', {
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(objects => {
            parentSelect.innerHTML = '<option value="">Без родительского объекта</option>';
            objects.forEach(obj => {
                const option = document.createElement('option');
                option.value = obj.id;
                option.textContent = `${obj.name} (${getObjectTypeName(obj.objectType)})`;
                parentSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading parent objects:', error);
            parentSelect.innerHTML = '<option value="">Ошибка загрузки</option>';
        });

        // Назначаем обработчик для СОЗДАНИЯ
        currentForm.onsubmit = function(e) {
            e.preventDefault();
            const objectName = document.getElementById('object-name').value;
            const objectType = document.getElementById('object-type').value;
            const parentId = document.getElementById('parent-select').value;
            const data = { name: objectName, objectType: objectType };
            if (parentId) { data.parentId = parseInt(parentId); }

            fetch('http://localhost:8080/real-estate-objects', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${jwtToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) { return response.text().then(text => { throw new Error(text || 'Ошибка при создании объекта'); }); }
                return response.json();
            })
            .then(data => {
                closeObjectModal();
                loadObjects(); // Обновляем главный список
            })
            .catch(error => {
                console.error('Ошибка при создании объекта:', error);
                alert('Ошибка при создании объекта: ' + error.message);
            });
        };

        modal.style.display = 'block';
    }

    // Функция для загрузки списка пользователей
    function loadUsers() {
        fetch("http://localhost:8080/users/info/all", {
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка загрузки пользователей');
            }
            return response.json();
        })
        .then(users => {
            const container = document.getElementById('users-content');
            container.innerHTML = `
                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Список пользователей</h3>
                    </div>
                    <div class="table-body">
                        <table class="users-table">
                            <thead>
                                <tr>
                                    <th class="id-cell sortable-header" onclick="sortTable('id')">ID</th>
                                    <th class="name-cell sortable-header" onclick="sortTable('username')">Имя пользователя</th>
                                    <th class="email-cell sortable-header" onclick="sortTable('email')">Email</th>
                                    <th class="name-cell sortable-header" onclick="sortTable('firstName')">Имя</th>
                                    <th class="name-cell sortable-header" onclick="sortTable('lastName')">Фамилия</th>
                                    <th class="role-cell sortable-header" onclick="sortTable('roles')">Роль</th>
                                    <th class="status-cell sortable-header" onclick="sortTable('active')">Статус</th>
                                    <th class="action-cell">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                ${users.length > 0 ? users.map(user => `
                                    <tr>
                                        <td class="id-cell">${user.id}</td>
                                        <td class="name-cell">${user.username}</td>
                                        <td class="email-cell">${user.email || '-'}</td>
                                        <td class="name-cell">${user.firstName || '-'}</td>
                                        <td class="name-cell">${user.lastName || '-'}</td>
                                        <td class="role-cell">
                                            ${user.roles ? (() => {
                                                let roleClass = 'status-new';
                                                let roleName = 'Пользователь';
                                                
                                                switch(user.roles) {
                                                    case 'ROLE_ADMIN':
                                                        roleClass = 'status-in-progress';
                                                        roleName = 'Админ';
                                                        break;
                                                    case 'ROLE_DIRECTOR':
                                                        roleClass = 'status-completed';
                                                        roleName = 'Директор';
                                                        break;
                                                    case 'ROLE_CHIEF':
                                                        roleClass = 'status-in-progress';
                                                        roleName = 'Начальник';
                                                        break;
                                                    case 'ROLE_RESPONSIBLE':
                                                        roleClass = 'status-new';
                                                        roleName = 'Ответственный';
                                                        break;
                                                }
                                                
                                                return `<span class="status-badge ${roleClass}">${roleName}</span>`;
                                            })() : '-'}
                                        </td>
                                        <td class="status-cell">
                                            <span class="status-badge ${user.active ? 'status-completed' : 'status-expired'}">
                                                ${user.active ? 'Активен' : 'Заблокирован'}
                                            </span>
                                        </td>
                                        <td class="action-cell">
                                            <div class="action-btn edit-btn" onclick="editUser(${user.id})" title="Редактировать">
                                                <i class="fas fa-edit"></i>
                                            </div>
                                            <div class="action-btn delete-btn" onclick="deleteUser(${user.id})" title="Удалить">
                                                <i class="fas fa-trash"></i>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('') : '<tr><td colspan="8" style="text-align: center;">Нет пользователей</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Сохраняем данные пользователей для сортировки
            window.usersData = users;
            // Инициализируем сортировку
            initSorting();
        })
        .catch(error => {
            console.error('Ошибка загрузки пользователей:', error);
            const container = document.getElementById('users-content');
            container.innerHTML = '<div class="error">Ошибка загрузки пользователей</div>';
        });
    }

    // Добавляем функции для сортировки
    let currentSort = {
        column: null,
        direction: 'asc'
    };

    function initSorting() {
        // Устанавливаем начальную сортировку по ID
        sortTable('id');
    }

    function sortTable(column) {
        const tbody = document.getElementById('users-table-body');
        const headers = document.querySelectorAll('.sortable-header');
        
        // Сбрасываем классы сортировки у всех заголовков
        headers.forEach(header => {
            header.classList.remove('asc', 'desc');
        });
        
        // Определяем направление сортировки
        if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.direction = 'asc';
        }
        
        // Добавляем класс сортировки к текущему заголовку
        const currentHeader = document.querySelector(`.sortable-header[onclick*="${column}"]`);
        currentHeader.classList.add(currentSort.direction);
        
        // Сортируем данные
        const sortedUsers = [...window.usersData].sort((a, b) => {
            let aValue = a[column];
            let bValue = b[column];
            
            // Обработка специальных случаев
            if (column === 'roles') {
                aValue = getRolePriority(a.roles);
                bValue = getRolePriority(b.roles);
            } else if (column === 'active') {
                aValue = a.active ? 1 : 0;
                bValue = b.active ? 1 : 0;
            }
            
            // Сравнение значений
            if (aValue === null || aValue === undefined) aValue = '';
            if (bValue === null || bValue === undefined) bValue = '';
            
            if (aValue < bValue) return currentSort.direction === 'asc' ? -1 : 1;
            if (aValue > bValue) return currentSort.direction === 'asc' ? 1 : -1;
            return 0;
        });
        
        // Обновляем таблицу
        tbody.innerHTML = sortedUsers.map(user => `
            <tr>
                <td class="id-cell">${user.id}</td>
                <td class="name-cell">${user.username}</td>
                <td class="email-cell">${user.email || '-'}</td>
                <td class="name-cell">${user.firstName || '-'}</td>
                <td class="name-cell">${user.lastName || '-'}</td>
                <td class="role-cell">
                    ${user.roles ? (() => {
                        let roleClass = 'status-new';
                        let roleName = 'Пользователь';
                        
                        switch(user.roles) {
                            case 'ROLE_ADMIN':
                                roleClass = 'status-in-progress';
                                roleName = 'Админ';
                                break;
                            case 'ROLE_DIRECTOR':
                                roleClass = 'status-completed';
                                roleName = 'Директор';
                                break;
                            case 'ROLE_CHIEF':
                                roleClass = 'status-in-progress';
                                roleName = 'Начальник';
                                break;
                            case 'ROLE_RESPONSIBLE':
                                roleClass = 'status-new';
                                roleName = 'Ответственный';
                                break;
                        }
                        
                        return `<span class="status-badge ${roleClass}">${roleName}</span>`;
                    })() : '-'}
                </td>
                <td class="status-cell">
                    <span class="status-badge ${user.active ? 'status-completed' : 'status-expired'}">
                        ${user.active ? 'Активен' : 'Заблокирован'}
                    </span>
                </td>
                <td class="action-cell">
                    <div class="action-btn edit-btn" onclick="editUser(${user.id})" title="Редактировать">
                        <i class="fas fa-edit"></i>
                    </div>
                    <div class="action-btn delete-btn" onclick="deleteUser(${user.id})" title="Удалить">
                        <i class="fas fa-trash"></i>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function getRolePriority(role) {
        switch(role) {
            case 'ROLE_ADMIN': return 1;
            case 'ROLE_DIRECTOR': return 2;
            case 'ROLE_CHIEF': return 3;
            case 'ROLE_RESPONSIBLE': return 4;
            case 'ROLE_USER': return 5;
            default: return 6;
        }
    }

    // Функция для удаления пользователя (заглушка)
    function deleteUser(userId) {
        if (!confirm('Вы уверены, что хотите удалить этого пользователя?')) {
            return;
        }

        fetch(`http://localhost:8080/users/${userId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка удаления пользователя');
            }
            loadUsers(); // Обновляем список пользователей после удаления
        })
        .catch(error => {
            console.error('Ошибка при удалении пользователя:', error);
            alert('Ошибка при удалении пользователя: ' + error.message);
        });
    }

    // Функция для открытия модального окна редактирования пользователя
    function editUser(userId) {
        const modal = document.getElementById('edit-user-modal');
        
        // Загружаем данные пользователя
        fetch(`http://localhost:8080/users/info/${userId}`, {
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка загрузки данных пользователя');
            }
            return response.json();
        })
        .then(user => {
            // Заполняем форму данными пользователя
            document.getElementById('edit-username').value = user.username;
            document.getElementById('edit-email').value = user.email || '';
            document.getElementById('edit-firstname').value = user.firstName || '';
            document.getElementById('edit-lastname').value = user.lastName || '';
            document.getElementById('edit-roles').value = user.roles || 'ROLE_USER';
            document.getElementById('edit-active').value = user.active ? 'true' : 'false';
            
            // Обработчик отправки формы
            document.getElementById('edit-user-form').onsubmit = function(e) {
                e.preventDefault();
                
                const firstName = document.getElementById('edit-firstname').value;
                const lastName = document.getElementById('edit-lastname').value;
                const email = document.getElementById('edit-email').value;
                const roles = document.getElementById('edit-roles').value;
                const active = document.getElementById('edit-active').value === 'true';
                
                const updatePromises = [];
                const updateTypes = [];
                
                if (firstName !== user.firstName) {
                    updatePromises.push(
                        fetch(`http://localhost:8080/users/update/${userId}/first-name`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${jwtToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ firstName })
                        })
                    );
                    updateTypes.push('имя');
                }
                
                if (lastName !== user.lastName) {
                    updatePromises.push(
                        fetch(`http://localhost:8080/users/update/${userId}/last-name`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${jwtToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ lastName })
                        })
                    );
                    updateTypes.push('фамилию');
                }
                
                if (email !== user.email) {
                    updatePromises.push(
                        fetch(`http://localhost:8080/users/update/${userId}/email`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${jwtToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ email })
                        })
                    );
                    updateTypes.push('email');
                }

                if (roles !== user.roles) {
                    updatePromises.push(
                        fetch(`http://localhost:8080/users/update/${userId}/role`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${jwtToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ role: roles })
                        })
                    );
                    updateTypes.push('роль');
                }

                if (active !== user.active) {
                    updatePromises.push(
                        fetch(`http://localhost:8080/users/update/${userId}/active`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${jwtToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ active })
                        })
                    );
                    updateTypes.push('статус активности');
                }

                if (updatePromises.length === 0) {
                    showNotification('error', 'Нет изменений', 'Не было внесено никаких изменений для сохранения');
                    return;
                }

                Promise.all(updatePromises)
                    .then(responses => {
                        const allSuccessful = responses.every(response => response.ok);
                        if (allSuccessful) {
                            const updatedFields = updateTypes.join(', ');
                            showNotification('success', 'Успешно', `Обновлены поля: ${updatedFields}`);
                            document.getElementById('edit-user-modal').style.display = 'none';
                            loadUsers();
                        } else {
                            throw new Error('Ошибка при обновлении данных');
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка при обновлении данных:', error);
                        const failedFields = updateTypes.join(', ');
                        showNotification('error', 'Ошибка', `Не удалось обновить поля: ${failedFields}`);
                    });
            };
            
            modal.style.display = 'block';
        })
        .catch(error => {
            console.error('Ошибка загрузки данных пользователя:', error);
            alert('Ошибка загрузки данных пользователя: ' + error.message);
        });
    }

    // Функция для закрытия модального окна редактирования пользователя
    function closeEditUserModal() {
        const modal = document.getElementById('edit-user-modal');
        modal.style.display = 'none';
    }

    // Функция для отображения уведомлений
    function showNotification(type, title, message) {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        
        notification.innerHTML = `
            <i class="fas ${icon}"></i>
            <div class="notification-content">
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            </div>
            <button class="notification-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        container.appendChild(notification);
        
        // Автоматическое удаление уведомления через 5 секунд
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    }
</script>
</body>
</html>